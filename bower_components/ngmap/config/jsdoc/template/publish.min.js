"use strict";var fs=require("jsdoc/fs");var helper=require("jsdoc/util/templateHelper");var logger=require("jsdoc/util/logger");var path=require("jsdoc/path");var taffy=require("taffydb").taffy;var template=require("jsdoc/template");var util=require("util");var htmlsafe=helper.htmlsafe;var linkto=helper.linkto;var resolveAuthorLinks=helper.resolveAuthorLinks;var scopeToPunc=helper.scopeToPunc;var hasOwnProp=Object.prototype.hasOwnProperty;var data;var view;var outdir=env.opts.destination;function find(a){return helper.find(data,a)}function tutoriallink(a){return helper.toTutorial(a,null,{tag:"em",classname:"disabled",prefix:"Tutorial: "})}function getAncestorLinks(a){return helper.getAncestorLinks(data,a)}function hashToLink(a,c){if(!/^(#.+)/.test(c)){return c}var b=helper.createLink(a);b=b.replace(/(#.+|$)/,c);return'<a href="'+b+'">'+c+"</a>"}function needsSignature(b){var d=false;if(b.kind==="function"||b.kind==="class"){d=true}else{if(b.kind==="typedef"&&b.type&&b.type.names&&b.type.names.length){for(var c=0,a=b.type.names.length;c<a;c++){if(b.type.names[c].toLowerCase()==="function"){d=true;break}}}}return d}function getSignatureAttributes(b){var a=[];if(b.optional){a.push("opt")}if(b.nullable===true){a.push("nullable")}else{if(b.nullable===false){a.push("non-null")}}return a}function updateItemName(b){var a=getSignatureAttributes(b);var c=b.name||"";if(b.variable){c="&hellip;"+c}if(a&&a.length){c=util.format('%s<span class="signature-attributes">%s</span>',c,a.join(", "))}return c}function addParamAttributes(a){return a.map(updateItemName)}function buildItemTypeStrings(b){var a=[];if(b.type&&b.type.names){b.type.names.forEach(function(c){a.push(linkto(c,htmlsafe(c)))})}return a}function buildAttribsString(b){var a="";if(b&&b.length){a=htmlsafe(util.format("(%s) ",b.join(", ")))}return a}function addNonParamAttributes(a){var b=[];a.forEach(function(c){b=b.concat(buildItemTypeStrings(c))});return b}function addSignatureParams(a){var b=a.params?addParamAttributes(a.params):[];a.signature=util.format("%s(%s)",(a.signature||""),b.join(", "))}function addSignatureReturns(d){var e=[];var c="";var b=[];var a="";if(d.returns){d.returns.forEach(function(f){helper.getAttribs(f).forEach(function(g){if(e.indexOf(g)===-1){e.push(g)}})});c=buildAttribsString(e)}if(d.returns){b=addNonParamAttributes(d.returns)}if(b.length){a=util.format(" &rarr; %s{%s}",c,b.join("|"))}d.signature='<span class="signature">'+(d.signature||"")+'</span><span class="type-signature">'+a+"</span>"}function addSignatureTypes(b){var a=b.type?buildItemTypeStrings(b):[];b.signature=(b.signature||"")+'<span class="type-signature">'+(a.length?" :"+a.join("|"):"")+"</span>"}function addAttribs(b){var c=helper.getAttribs(b);var a=buildAttribsString(c);b.attribs=util.format('<span class="type-signature">%s</span>',a)}function shortenPaths(b,a){Object.keys(b).forEach(function(c){b[c].shortened=b[c].resolved.replace(a,"").replace(/\\/g,"/")});return b}function getPathFromDoclet(a){if(!a.meta){return null}return a.meta.path&&a.meta.path!=="null"?path.join(a.meta.path,a.meta.filename):a.meta.filename}function generate(g,f,c,d){d=d===false?false:true;var b={title:g,docs:f};var a=path.join(outdir,c),e=view.render("container.tmpl",b);if(d){e=helper.resolveLinks(e)}fs.writeFileSync(a,e,"utf8")}function generateSourceFiles(a,b){b=b||"utf8";Object.keys(a).forEach(function(c){var f;var d=helper.getUniqueFilename(a[c].shortened);helper.registerLink(a[c].shortened,d);try{f={kind:"source",code:helper.htmlsafe(fs.readFileSync(a[c].resolved,b))}}catch(g){logger.error("Error while generating source file %s: %s",c,g.message)}generate("Source: "+a[c].shortened,[f],d,false)})}function attachModuleSymbols(a,c){var b={};a.forEach(function(d){b[d.longname]=d});return c.map(function(d){if(b[d.longname]){d.module=b[d.longname];d.module.name=d.module.name.replace("module:",'(require("')+'"))'}})}function buildNav(e){var a='<h2><a href="index.html">Index</a></h2>',b={},d=false,k="";if(e.modules.length){a+="<h3>Modules</h3><ul>";e.modules.forEach(function(i){if(!hasOwnProp.call(b,i.longname)){a+="<li>"+linkto(i.longname,i.name)+"</li>"}b[i.longname]=true});a+="</ul>"}if(e.externals.length){a+="<h3>Externals</h3><ul>";e.externals.forEach(function(i){if(!hasOwnProp.call(b,i.longname)){a+="<li>"+linkto(i.longname,i.name.replace(/(^"|"$)/g,""))+"</li>"}b[i.longname]=true});a+="</ul>"}if(e.classes.length){var c={};for(var f=0;f<e.classes.length;f++){var g=e.classes[f];var j=g.ngdoc||"class";c[j]=c[j]||[];c[j].push(g)}for(var j in c){var h="";c[j].forEach(function(i){if(!hasOwnProp.call(b,i.longname)){h+="<li>"+linkto(i.longname,i.name)+"</li>"}b[i.longname]=true});if(h!==""){a+="<h3>"+j+"</h3><ul>";a+=h;a+="</ul>"}}}if(e.events.length){a+="<h3>Events</h3><ul>";e.events.forEach(function(i){if(!hasOwnProp.call(b,i.longname)){a+="<li>"+linkto(i.longname,i.name)+"</li>"}b[i.longname]=true});a+="</ul>"}if(e.namespaces.length){a+="<h3>Namespaces</h3><ul>";e.namespaces.forEach(function(i){if(!hasOwnProp.call(b,i.longname)){a+="<li>"+linkto(i.longname,i.longname)+"</li>"}b[i.longname]=true});a+="</ul>"}if(e.mixins.length){a+="<h3>Mixins</h3><ul>";e.mixins.forEach(function(i){if(!hasOwnProp.call(b,i.longname)){a+="<li>"+linkto(i.longname,i.name)+"</li>"}b[i.longname]=true});a+="</ul>"}if(e.tutorials.length){a+="<h3>Tutorials</h3><ul>";e.tutorials.forEach(function(i){a+="<li>"+tutoriallink(i.name)+"</li>"});a+="</ul>"}if(e.globals.length){e.globals.forEach(function(i){if(i.kind!=="typedef"&&!hasOwnProp.call(b,i.longname)){k+="<li>"+linkto(i.longname,i.name)+"</li>"}b[i.longname]=true});if(!k){a+="<h3>"+linkto("global","Global")+"</h3>"}else{a+="<h3>Global</h3><ul>"+k+"</ul>"}}return a}exports.publish=function(z,l,g){data=z;var j=env.conf.templates||{};j["default"]=j["default"]||{};var w=l.template;view=new template.Template(w+"/tmpl");var f=helper.getUniqueFilename("index");var r=helper.getUniqueFilename("global");helper.registerLink("global",r);view.layout=j["default"].layoutFile?path.getResourcePath(path.dirname(j["default"].layoutFile),path.basename(j["default"].layoutFile)):"layout.tmpl";helper.setTutorials(g);data=helper.prune(data);data.sort("longname, version, since");helper.addEventListeners(data);var d={};var n=[];data().each(function(A){A.attribs="";if(A.examples){A.examples=A.examples.map(function(C){var D,E;if(C.match(/^\s*<caption>([\s\S]+?)<\/caption>(\s*[\n\r])([\s\S]+)$/i)){D=RegExp.$1;E=RegExp.$3}return{caption:D||"",code:E||C}})}if(A.see){A.see.forEach(function(D,C){A.see[C]=hashToLink(A,D)})}var B;if(A.meta){B=getPathFromDoclet(A);d[B]={resolved:B,shortened:null};if(n.indexOf(B)===-1){n.push(B)}}});var k=(find({kind:"package"})||[])[0];if(k&&k.name){outdir=path.join(outdir,k.name,k.version)}fs.mkPath(outdir);var b=path.join(w,"static");var h=fs.ls(b,3);h.forEach(function(B){var A=fs.toDir(B.replace(b,outdir));fs.mkPath(A);fs.copyFileSync(B,A)});var p;var t;var y;if(j["default"].staticFiles){p=j["default"].staticFiles.paths||[];t=new (require("jsdoc/src/filter")).Filter(j["default"].staticFiles);y=new (require("jsdoc/src/scanner")).Scanner();p.forEach(function(B){var A=y.scan([B],10,t);A.forEach(function(E){var C=fs.toDir(B);var D=fs.toDir(E.replace(C,outdir));fs.mkPath(D);fs.copyFileSync(E,D)})})}if(n.length){d=shortenPaths(d,path.commonPrefix(n))}data().each(function(A){var B=helper.createLink(A);helper.registerLink(A.longname,B);var C;if(A.meta){C=getPathFromDoclet(A);C=d[C].shortened;if(C){A.meta.shortpath=C}}});data().each(function(A){var B=helper.longnameToUrl[A.longname];if(B.indexOf("#")>-1){A.id=helper.longnameToUrl[A.longname].split(/#/).pop()}else{A.id=A.name}if(needsSignature(A)){addSignatureParams(A);addSignatureReturns(A);addAttribs(A)}});data().each(function(A){A.ancestors=getAncestorLinks(A);if(A.kind==="member"){addSignatureTypes(A);addAttribs(A)}if(A.kind==="constant"){addSignatureTypes(A);addAttribs(A);A.kind="member"}});var x=helper.getMembers(data);x.tutorials=g.children;var q=j["default"]&&j["default"].outputSourceFiles!==false?true:false;view.find=find;view.linkto=linkto;view.resolveAuthorLinks=resolveAuthorLinks;view.tutoriallink=tutoriallink;view.htmlsafe=htmlsafe;view.outputSourceFiles=q;view.nav=buildNav(x);attachModuleSymbols(find({kind:["class","function"],longname:{left:"module:"}}),x.modules);if(q){generateSourceFiles(d,l.encoding)}if(x.globals.length){generate("Global",[{kind:"globalobj"}],r)}var e=find({kind:"file"}),o=find({kind:"package"});generate("Index",o.concat([{kind:"mainpage",readme:l.readme,longname:(l.mainpagetitle)?l.mainpagetitle:"Main Page"}]).concat(e),f);var u=taffy(x.classes);var v=taffy(x.modules);var i=taffy(x.namespaces);var c=taffy(x.mixins);var m=taffy(x.externals);Object.keys(helper.longnameToUrl).forEach(function(F){var B=helper.find(u,{longname:F});if(B.length){var E=B[0].ngdoc?B[0].ngdoc:"Class";generate(E+": "+B[0].name,B,helper.longnameToUrl[F])}var A=helper.find(v,{longname:F});if(A.length){generate("Module: "+A[0].name,A,helper.longnameToUrl[F])}var G=helper.find(i,{longname:F});if(G.length){generate("Namespace: "+G[0].name,G,helper.longnameToUrl[F])}var C=helper.find(c,{longname:F});if(C.length){generate("Mixin: "+C[0].name,C,helper.longnameToUrl[F])}var D=helper.find(m,{longname:F});if(D.length){generate("External: "+D[0].name,D,helper.longnameToUrl[F])}});function s(F,E,A){var B={title:F,header:E.title,content:E.parse(),children:E.children};var D=path.join(outdir,A),C=view.render("tutorial.tmpl",B);C=helper.resolveLinks(C);fs.writeFileSync(D,C,"utf8")}function a(A){A.children.forEach(function(B){s("Tutorial: "+B.title,B,helper.tutorialToUrl(B.name));a(B)})}a(g)};